pipeline {
    agent {
        kubernetes {
            yaml '''
            apiVersion: v1
            kind: Pod
            spec:
              containers:
              - name: buildah
                image: quay.io/buildah/stable:latest
                securityContext:
                  privileged: true
                command: ["sleep"]
                args: ["infinity"]
                env:
                - name: STORAGE_DRIVER
                  value: vfs
                volumeMounts:
                  - name: varlibcontainers
                    mountPath: /var/lib/containers
              
              - name: trivy
                image: aquasec/trivy:latest
                command: ["sleep"]
                args: ["infinity"]
                
              - name: sonar-scanner
                image: sonarsource/sonar-scanner-cli:latest
                command: ["sleep"]
                args: ["infinity"]
                
              volumes:
                - name: varlibcontainers
                  emptyDir: {}
            '''
        }
    }

    environment {
        SERVICE_NAME = 'result'
        DOCKERHUB_USER = 'quackusarle'
        REPO_USER = 'Quackusarle'
        REPO_NAME = 'example-voting-app'
        BRANCH = 'main'
        SONAR_SERVER_CONFIG_NAME = 'sonar-server'
    }
    
    stages {
        stage('Code Analysis') {
            parallel {
                stage('SonarQube Analysis') {
                    steps {
                        dir(SERVICE_NAME) {
                            container('sonar-scanner') {
                                withCredentials([string(credentialsId: 'sonarqube-token', variable: 'SONAR_TOKEN')]) {
                                    withSonarQubeEnv(SONAR_SERVER_CONFIG_NAME) {
                                        sh """
                                            sonar-scanner \
                                            -Dsonar.projectKey=example-voting-app-${SERVICE_NAME} \
                                            -Dsonar.projectName="Voting App - ${SERVICE_NAME}" \
                                            -Dsonar.sources=. \
                                            -Dsonar.host.url=http://sonarqube.sonarqube.svc.cluster.local:9000 \
                                            -Dsonar.token=${SONAR_TOKEN}
                                        """
                                    }
                                }
                            }
                        }
                        //timeout(time: 5, unit: 'MINUTES') {
                        //    waitForQualityGate abortPipeline: true
                        //}
                    }
                }

                stage('Trivy Code Scan') {
                    steps {
                        dir(SERVICE_NAME) {
                            container('trivy') {
                                sh "mkdir -p .trivy-cache"
                                sh """
                                    trivy fs \
                                    --cache-dir .trivy-cache \
                                    --exit-code 0 \
                                    --severity HIGH,CRITICAL \
                                    .
                                """
                            }
                        }
                    }
                }
            }
        }

        stage('Build and Push') {
            steps {
                dir(SERVICE_NAME) {
                    withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                        container('buildah') {
                            sh "buildah login -u ${USER} -p ${PASS} docker.io"
                            sh "buildah bud --format docker -t ${DOCKERHUB_USER}/${SERVICE_NAME}:${BUILD_NUMBER} ."
                            sh "buildah bud --format docker -t ${DOCKERHUB_USER}/${SERVICE_NAME}:latest ."
                            sh "buildah push ${DOCKERHUB_USER}/${SERVICE_NAME}:${BUILD_NUMBER}"
                            sh "buildah push ${DOCKERHUB_USER}/${SERVICE_NAME}:latest"
                        }
                    }
                }
            }
        }

        stage('Security Scan (Image)') {
            steps {
                container('trivy') {
                    sh "mkdir -p .trivy-cache"
                    sh """
                        trivy image \
                        --cache-dir .trivy-cache \
                        --no-progress \
                        --timeout 15m \
                        --exit-code 0 \
                        --severity HIGH,CRITICAL \
                        ${DOCKERHUB_USER}/${SERVICE_NAME}:${BUILD_NUMBER}
                    """
                }
            }
        }

        stage('Update Helm Values') {
            steps {
                withCredentials([string(credentialsId: 'github-credentials', variable: 'GITHUB_TOKEN')]) {
                    script {
                        sh 'git config --global user.email "jenkins-ci@bot.com"'
                        sh 'git config --global user.name "Jenkins CI Bot"'

                        def valuesFile = "voting-app-chart/values.yaml"
                        def newRepo = "${DOCKERHUB_USER}/${SERVICE_NAME}"
                        
                        sh "sed -i -e '/^${SERVICE_NAME}:/,/^[a-zA-Z]/{s|  repository: .*|  repository: \"${newRepo}\"|}' ${valuesFile}"
                        sh "sed -i -e '/^${SERVICE_NAME}:/,/^[a-zA-Z]/{s|  tag: .*|  tag: \"${BUILD_NUMBER}\"|}' ${valuesFile}"

                        sh "git add ${valuesFile}"
                        sh "git diff-index --quiet HEAD || git commit -m 'CI: Update image for ${SERVICE_NAME} to tag ${BUILD_NUMBER}'"
                        
                        def remoteUrlWithToken = "https://${REPO_USER}:${GITHUB_TOKEN}@github.com/${REPO_USER}/${REPO_NAME}.git"
                        sh "git push ${remoteUrlWithToken} HEAD:${BRANCH}"
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                try { container('buildah') { sh 'buildah logout docker.io' } } catch (e) {}
            }
        }
    }
}